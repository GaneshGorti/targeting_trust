{% extends "global/Page.html" %}
{% block content %}

<style>
/* --- Layout --- */
.main-container{
    display:flex;
    gap:40px;
    align-items:flex-start;
}

/* Left info panel */
.info-panel{
    width:320px;
    background:#f7f7f7;
    padding:15px;
    border-radius:8px;
}

/* Right task panel */
.task-panel{
    flex-grow:1;
}

/* Sliders vertical spacing */
.slider-row{
    margin-bottom:18px;
}

/* Timer emphasis */
#time{
    font-weight:bold;
    font-size:18px;
    color:#c0392b;
}
</style>

<h2>Work and Earnings Phase</h2>

<div class="main-container">

    <!-- LEFT SIDE (information) -->
    <div class="info-panel">

        <p>
        In this task you will complete small work units.  
        Each correctly positioned slider generates 1 ECU (which is equal to Â£0.10) and a tax of 0.3 ETU (which is equal to Â£0.03).
        The more sliders you place correctly, the more income you earn, but also the more tax you pay.
        Your tax is calculated by the administrator assigned to your group, and is either based on a true count of your completed tasks, or an estimation of the completed tasks. 
        The tax will be deducted from your final payment.
        All members of your group see the same work task.
        </p>

        <hr>

        <h4>Your progress</h4>
        <table style="width:100%">
            <tr><td>Correct tasks:</td><td><strong id="effort">0</strong></td></tr>
            <tr><td>Gross income earned:</td><td><strong id="gross">0</strong> ECU</td></tr>
        </table>

        <hr>

        <p>
        Time remaining: <span id="time">90</span> seconds
        </p>

    </div>


    <!-- RIGHT SIDE (task) -->
    <div class="task-panel">

        <h3>Task</h3>
        <p>Move each slider so it is exactly in the middle (50).</p>

        <div id="slider-area"></div>

    </div>

</div>

{{ next_button }}

<script>
const TARGET = 50;
const TOLERANCE = 0;
const SLIDERS = 10;
let timeLeft = 90;

/* ---------- create sliders ---------- */
function makeSlider(id) {

let div = document.createElement("div");
div.className = "slider-row";

// Random horizontal offset (0â€“120px)
div.style.marginLeft = Math.floor(Math.random() * 120) + "px";

let slider = document.createElement("input");
slider.type = "range";
slider.min = 0;
slider.max = 100;

// Random starting value far from 50 (optional but good)
function randomStart() {
    if (Math.random() < 0.5) {
        return Math.floor(Math.random() * 20);     // 0â€“19
    } else {
        return 80 + Math.floor(Math.random() * 20); // 80â€“99
    }
}
slider.value = randomStart();

// ðŸ”€ Random width (250â€“550px)
let width = 250 + Math.floor(Math.random() * 300);
slider.style.width = width + "px";

let label = document.createElement("span");
label.style.marginLeft = "10px";
label.innerText = slider.value;

slider.oninput = function() {
    label.innerText = slider.value;
};

slider.onchange = function() {
    let val = parseInt(slider.value);
    if (Math.abs(val - TARGET) <= TOLERANCE) {
        earnPoint(slider, label);
    }
};

div.appendChild(slider);
div.appendChild(label);
return div;
}

/* ---------- earning ---------- */
function earnPoint(slider,label){
    console.log("CLICK SENT");
    slider.disabled=true;
    label.innerText="âœ“";

    liveSend({type:"click"});

    // replace only this slider (not all)
    setTimeout(()=>{
        slider.parentElement.replaceWith(makeSlider());
    },300);
}

/* ---------- receive updates ---------- */
function liveRecv(data){
    document.getElementById("effort").innerText = data.effort;
    document.getElementById("gross").innerText = data.gross.toFixed(2);
}

/* ---------- timer ---------- */
populate();

let timer=setInterval(function(){
    timeLeft--;
    document.getElementById("time").innerText=timeLeft;

    if(timeLeft<=0){
        clearInterval(timer);
        document.getElementById("slider-area").innerHTML="<p><strong>Work period finished.</strong></p>";
    }
},1000);
</script>

{% endblock %}
