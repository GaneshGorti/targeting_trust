{% extends "global/Page.html" %}
{% block content %}

<input type="hidden" name="work_page_completed" value="True">

<div id="readyOverlay" style="
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background:white;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:1000;
">

    <h2>Work Task</h2>
    <p>The task will last up to 60 seconds.</p>
    <button type="button" id="startBtn" style="padding:10px 25px; font-size:18px;">
        Ready
    </button>

</div>

<style>
/* --- Layout --- */
.main-container{
    display:flex;
    gap:40px;
    align-items:flex-start;
}

/* Left info panel */
.info-panel{
    width:320px;
    background:#f7f7f7;
    padding:15px;
    border-radius:8px;
}

/* Right task panel */
.task-panel{
    flex-grow:1;
}

/* Sliders vertical spacing */
.slider-row{
    margin-bottom:18px;
}

/* Timer emphasis */
#time{
    font-weight:bold;
    font-size:18px;
    color:#c0392b;
}
</style>

<h2>Task Phase</h2>

<div class="main-container">

    <!-- LEFT SIDE (information) -->
    <div class="info-panel">

        <hr>

        <h4>Your progress</h4>
        <table style="width:100%">
            <tr><td>Correct tasks:</td><td><strong id="effort">0</strong></td></tr>
            <tr><td>Gross income earned:</td><td><strong id="gross">0</strong> ECU</td></tr>
        </table>

        <hr>

        <p>
        Time remaining: <span id="time">60</span> seconds
        </p>

    </div>


    <!-- RIGHT SIDE (task) -->
    <div class="task-panel">

        <h3>Task</h3>
        <p>Move each slider so it is exactly in the middle (50).</p>

        <div id="slider-area"></div>

    </div>

</div>

<div id="nextBtn" style="display:none;">
    {{ next_button }}
</div>

<script>
const TARGET = 50;
const TOLERANCE = 0;
const SLIDERS = 1;
let timeLeft = 60;
let timer = null;

/* ---------- random start far from 50 ---------- */
function randomStart() {
    if (Math.random() < 0.5) {
        return Math.floor(Math.random() * 20);      // 0–19
    } else {
        return 80 + Math.floor(Math.random() * 20); // 80–99
    }
}

/* ---------- create sliders ---------- */
function makeSlider(id) {

    let div = document.createElement("div");
    div.className = "slider-row";

    let slider = document.createElement("input");
    slider.type = "range";
    slider.min = 0;
    slider.max = 100;
    slider.value = randomStart();
    //random slider width
    let width = 250 + Math.floor(Math.random() * 200); // 250–450px
    slider.style.width = width + "px";

    let label = document.createElement("span");
    label.style.marginLeft = "10px";
    label.innerText = slider.value;

    slider.oninput = function() {
        label.innerText = slider.value;
    }

    slider.onchange = function() {
        let val = parseInt(slider.value);
        if (Math.abs(val - TARGET) <= TOLERANCE) {
            earnPoint(slider, label);
        }
    }

    div.appendChild(slider);
    div.appendChild(label);
    return div;
}

function populate(){
    let area = document.getElementById("slider-area");
    for(let i=0;i<SLIDERS;i++){
        area.appendChild(makeSlider(i));
    }
}

/* ---------- earning ---------- */
function earnPoint(slider,label){
    slider.disabled=true;
    label.innerText="✓";

    liveSend({type:"click"});

    // replace only this slider (not all)
    setTimeout(()=>{
        slider.parentElement.replaceWith(makeSlider());
    },300);
}

/* ---------- receive updates ---------- */
function liveRecv(data){
    document.getElementById("effort").innerText = data.effort;
    document.getElementById("gross").innerText = data.gross.toFixed(2);
}

/* ---------- start task ---------- */
document.getElementById("startBtn").onclick = function(){

    // hide overlay
document.getElementById("readyOverlay").style.display = "none";

    // populate sliders
    populate();

    // start timer
    timer = setInterval(function(){
        timeLeft--;
        document.getElementById("time").innerText = timeLeft;

        if(timeLeft <= 0){
            clearInterval(timer);
            document.querySelector("#nextBtn button").click();
        }
    },1000);
};
</script>

{% endblock %}
